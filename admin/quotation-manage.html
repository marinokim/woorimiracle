<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Management - Woori Miracle</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #333;
            color: white;
            padding: 20px;
        }

        .sidebar a {
            display: block;
            color: #aaa;
            padding: 15px;
            text-decoration: none;
        }

        .sidebar a:hover,
        .sidebar a.active {
            color: white;
            background: #444;
            border-radius: 4px;
        }

        .content {
            flex: 1;
            padding: 40px;
            background: #f9f9f9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <div class="sidebar">
            <h3 style="color: white; margin-bottom: 30px; padding-left: 15px;">Admin Panel</h3>
            <a href="dashboard.html">Dashboard</a>
            <a href="product-manage.html">Product Management</a>
            <a href="notice-manage.html">Notice Management</a>
            <a href="quotation-manage.html" class="active">Quotation Management</a>
            <hr style="border: none; border-top: 1px solid #555; margin: 20px 0;">
            <a href="../index.html" style="color: #4CAF50;">ğŸ  ë©”ì¸ í™ˆí˜ì´ì§€ë¡œ</a>
            <a href="#" onclick="logout()" style="margin-top: 30px; color: #ff6b6b;">Logout</a>
        </div>
        <div class="content">
            <h1 style="margin-bottom: 30px;">Quotation Management</h1>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <input type="text" id="search-input" placeholder="ì—…ì²´ëª… ë˜ëŠ” ê²¬ì ë²ˆí˜¸ ê²€ìƒ‰..." style="flex: 1;">
                <select id="status-filter" onchange="filterQuotations()">
                    <option value="all">ì „ì²´ ìƒíƒœ</option>
                    <option value="pending">ëŒ€ê¸°</option>
                    <option value="reviewing">ê²€í† ì¤‘</option>
                    <option value="quoted">ê²¬ì ì™„ë£Œ</option>
                    <option value="ordered">ë°œì£¼ì™„ë£Œ</option>
                    <option value="cancelled">ì·¨ì†Œë¨</option>
                </select>
                <button class="btn btn-outline" onclick="filterQuotations()">ğŸ” ê²€ìƒ‰</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ê²¬ì ë²ˆí˜¸</th>
                        <th>ì—…ì²´ëª…</th>
                        <th>ì—°ë½ì²˜</th>
                        <th>ìš”ì²­ì¼</th>
                        <th>ì´ì•¡</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="quotation-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Detail & Edit Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 30px;">
                <h2 id="modal-quotation-id"></h2>
                <button onclick="closeModal()"
                    style="font-size: 1.5rem; border: none; background: none; cursor: pointer;">Ã—</button>
            </div>

            <!-- Customer Info -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ê³ ê° ì •ë³´</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>íšŒì‚¬ëª…:</strong> <span id="modal-company"></span>
                    </div>
                    <div>
                        <strong>ë‹´ë‹¹ì:</strong> <span id="modal-name"></span>
                    </div>
                    <div>
                        <strong>ì—°ë½ì²˜:</strong> <span id="modal-phone"></span>
                    </div>
                    <div>
                        <strong>ì´ë©”ì¼:</strong> <span id="modal-email"></span>
                    </div>
                    <div>
                        <strong>ìš”ì²­ì¼:</strong> <span id="modal-date"></span>
                    </div>
                    <div>
                        <strong>ì´ ê¸ˆì•¡:</strong> <strong id="modal-total" style="color: var(--primary-color);"></strong>
                    </div>
                </div>
            </div>

            <!-- Items -->
            <h3 style="margin-bottom: 15px;">ìƒí’ˆ ëª©ë¡</h3>
            <div id="modal-items" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                <!-- Items will be injected -->
            </div>

            <!-- Notes -->
            <div id="modal-customer-note" style="margin-bottom: 20px;">
                <!-- Customer note will be injected -->
            </div>

            <!-- Admin Actions -->
            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ê´€ë¦¬ì ì‘ì—…</h3>
                <div class="form-group">
                    <label>ìƒíƒœ ë³€ê²½</label>
                    <select id="modal-status-select">
                        <option value="pending">ëŒ€ê¸°</option>
                        <option value="reviewing">ê²€í† ì¤‘</option>
                        <option value="quoted">ê²¬ì ì™„ë£Œ</option>
                        <option value="ordered">ë°œì£¼ì™„ë£Œ</option>
                        <option value="cancelled">ì·¨ì†Œë¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ê´€ë¦¬ì ë©”ëª¨</label>
                    <textarea id="modal-admin-note" rows="3" placeholder="ê³ ê°ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="flex gap-4">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveChanges()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                <button class="btn" style="flex: 1; background: #f44336;" onclick="deleteQuotation()">ê²¬ì  ì‚­ì œ</button>
                <button class="btn btn-outline" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script src="../js/quotation-manager.js"></script>
    <script>
        checkAuth();

        let currentQuotation = null;

        const renderList = (quotations = null) => {
            const list = document.getElementById('quotation-list');
            list.innerHTML = '';

            const data = quotations || quotationManager.getAll();

            if (data.length === 0) {
                list.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">ê²¬ì  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ìµœì‹ ìˆœ ì •ë ¬
            const sorted = data.sort((a, b) => b.createdAt - a.createdAt);

            sorted.forEach(q => {
                const tr = document.createElement('tr');
                const statusColor = quotationManager.STATUS_COLORS[q.status];
                const statusLabel = quotationManager.STATUS_LABELS[q.status];

                tr.innerHTML = `
                    <td><strong>${q.id}</strong></td>
                    <td>${q.userCompany || q.userName}</td>
                    <td>${q.userPhone || '-'}</td>
                    <td>${q.date}</td>
                    <td>â‚©${q.totalAmount.toLocaleString()}</td>
                    <td><span class="status-badge" style="background: ${statusColor};">${statusLabel}</span></td>
                    <td>
                        <button onclick="viewDetail('${q.id}')" style="cursor: pointer; margin-right: 5px;">ìƒì„¸ë³´ê¸°</button>
                    </td>
                `;
                list.appendChild(tr);
            });
        };

        const filterQuotations = () => {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            let quotations = quotationManager.getAll();

            // Status filter
            if (statusFilter !== 'all') {
                quotations = quotations.filter(q => q.status === statusFilter);
            }

            // Search filter
            if (searchTerm) {
                quotations = quotations.filter(q =>
                    q.id.toLowerCase().includes(searchTerm) ||
                    (q.userCompany && q.userCompany.toLowerCase().includes(searchTerm)) ||
                    (q.userName && q.userName.toLowerCase().includes(searchTerm))
                );
            }

            renderList(quotations);
        };

        const viewDetail = (quotationId) => {
            const q = quotationManager.getById(quotationId);
            if (!q) return;

            currentQuotation = q;

            document.getElementById('modal-quotation-id').innerText = q.id;
            document.getElementById('modal-company').innerText = q.userCompany || '-';
            document.getElementById('modal-name').innerText = q.userName;
            document.getElementById('modal-phone').innerText = q.userPhone || '-';
            document.getElementById('modal-email').innerText = q.userEmail || '-';
            document.getElementById('modal-date').innerText = q.date;
            document.getElementById('modal-total').innerText = `â‚©${q.totalAmount.toLocaleString()}`;

            // Items
            const itemsContainer = document.getElementById('modal-items');
            itemsContainer.innerHTML = '';
            q.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div>
                        <strong>${index + 1}. ${item.name}</strong>
                        <div style="font-size: 0.85rem; color: #888;">${item.category} Ã— ${item.quantity}ê°œ / ë‹¨ê°€: â‚©${item.price.toLocaleString()}</div>
                    </div>
                    <div style="text-align: right;">
                        <strong>â‚©${(item.price * item.quantity).toLocaleString()}</strong>
                    </div>
                `;
                itemsContainer.appendChild(div);
            });

            // Customer note
            const customerNoteContainer = document.getElementById('modal-customer-note');
            if (q.customerNote) {
                customerNoteContainer.innerHTML = `
                    <div style="background: #fff9c4; padding: 15px; border-radius: 8px;">
                        <strong>ğŸ’¬ ê³ ê° ë©”ëª¨:</strong><br>${q.customerNote}
                    </div>
                `;
            } else {
                customerNoteContainer.innerHTML = '';
            }

            // Set current status and admin note
            document.getElementById('modal-status-select').value = q.status;
            document.getElementById('modal-admin-note').value = q.adminNote || '';

            document.getElementById('detail-modal').style.display = 'flex';
        };

        const closeModal = () => {
            document.getElementById('detail-modal').style.display = 'none';
            currentQuotation = null;
        };

        const saveChanges = () => {
            if (!currentQuotation) return;

            const newStatus = document.getElementById('modal-status-select').value;
            const adminNote = document.getElementById('modal-admin-note').value;

            quotationManager.update(currentQuotation.id, {
                status: newStatus,
                adminNote: adminNote
            });

            alert('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal();
            renderList();
        };

        const deleteQuotation = () => {
            if (!currentQuotation) return;

            if (confirm(`ì •ë§ë¡œ ì´ ê²¬ì (${currentQuotation.id})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                quotationManager.remove(currentQuotation.id);
                alert('ê²¬ì ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
                renderList();
            }
        };

        // Search on Enter key
        document.getElementById('search-input').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                filterQuotations();
            }
        });

        renderList();
    </script>
</body>

</html>